# On-board-computer
Программа для бортового компьютера с использованием Arduino для мотоцикла.

## Содержание
- [Возможности данной системы](#possibilities)
- [Настройки в программе](#settings)
- [Версии](#versions)

![Снимок экрана (269)](https://user-images.githubusercontent.com/98914596/152302594-038accc3-8d7a-41bd-a859-1d5ee7e6715a.png)

![Снимок экрана (315)](https://user-images.githubusercontent.com/98914596/152304932-b542c358-555f-4f2a-b90a-e0459858ce10.png)

![Снимок экрана (322)](https://user-images.githubusercontent.com/98914596/152306161-d93440b4-e3fa-4f79-a25c-1ad9fa971339.png)

![Снимок экрана (544)](https://user-images.githubusercontent.com/98914596/199455337-e09b5fae-a4e7-4f53-92f3-4d579ebb58d6.png)


<a id="possibilities"></a>
## Возможности данной системы
- На дисплее отображаются показания температуры цилиндров, напряжение в сети мотоцикла. 
- В правом верхнем углу выводятся предупреждения: высокое/низкое напряжение в сети, перегрев цилиндров. 
- Повторители указателей поворота отображаются на дисплее в виде стрелок, а также загорается светодиод и, если включить опцию в настройках, звучит пищалка. 
- При нажатии на кнопку на индикаторе высвечивается версия установленной программы, а на дисплее время текущей поездки. 
- При двойном нажатии на кнопку на индикаторе отображается количество оставшейся оперативной памяти, на дисплее – моточасы и температура процессора. 
- Система имеет ряд настроек:
  - при долгом нажатии на кнопку на индикаторе отображается “tune” и открывается меню настроек;
  - первый пункт – яркость индикатора TM1637 от 0 до 7;
  - второй – настройка минимального напряжения;
  - третий – настройка максимального напряжения;
  - четвёртый – включение пьезоэлемента;
  - пятый изменяет яркость светодиода;
  - шестой обнуляет счётчик моточасов;
  - седьмой изменяет порог показа максимальной температуры цилиндров;
  - восьмой - тест пьезоэлемента.

`Все настройки, в том числе и моточасы, сохраняют свои значения после отключения питания, благодаря встроенной энергонезависимой памяти EEPROM (Electrically Erasable Programmable Read-Only Memory) – электрически стираемого программируемого ПЗУ.
 Настройки минимального напряжения необходима для корректного отображения предупреждений и корректной записи в EEPROM. Настройка максимального напряжения необходима для корректного отображения предупреждений. Настроить порог показа предупреждения о перегреве цилиндра можно любой.`
 
 <a id="settings"></a>
## Настройки в программе
```cpp
//энкодер (EB_BETTER_ENC (установлен по умолчанию с версии 2.0 библиотеки), EB_HALFSTEP_ENC, EB_FAST, keypin, A, B (пины энкодера)),
//указатели поворота (turnpin1, turnpin2), TM1637 (CLK, DIO), аналоговые преобразования (analogpin1, analogpin2, сопротивление резисторов r1, r2,
//r3, r4 в делителе напряжения, калибровка calibration1, calibration2), калибровка температуры процессора (tempsizing), пин пищалки (buzz),
//LiquidCrystal_I2C (настройка адреса), MAX6675_DELAY (задержка переключения CLK в микросекундах для улучшения связи по длинным проводам),
//настройка меню (SETTINGS_AMOUNT, FAST_STEP), настройки препроцессором (bufferBatt, RPMwarning, buzzPassive, buzzActive, OneCylinder, TwoCylinders).
```
<a id="versions"></a>
## Версии
`старые версии находятся в LOG-versions.md. Они не предназначены для системы на плате`

- v2.0 версия для системы на печатной плате с мк-к Arduino Pro Mini, добавлена поддержка раздельного питания системы (с буферным аккумулятором, отключается от основной системы
при включении зажигания, при выключенном зажигании заряжается от основного аккумулятора), показание напряжения буферного аккумулятора при 1 нажатии на кнопку, 
предупреждение о низком заряде аккумулятора, небольшие правки кода;
- v2.1 добавлены новые символы для LCD 1602, доработан фильтр на сравнении - сравнение делается по модулю, усредняется, ускораена его работа, добавлены удобные макросы,
некоторые части кода переписаны в универсальные библиотеки, исправление недочётов; //15.10.21
- v2.2 Применена библиотека Tachometer (https://github.com/GyverLibs/Tachometer) для более оптимального считывания количества RPM, имеет встроенный медианный фильтр,
убраны все фильтры RPM (необходимо фильтровать не RPM, а резкие изменения количества времени между сигналами), изменены действия после нажатия кнопки, 
оптимизация кода; //20.12.21
- v2.3 применена библиотека EncButton (https://github.com/GyverLibs/EncButton) для работы с энкодером и кнопкой, написано меню с настройками (пока только яркость TM1637) в 
LCD1602, изменены действия кнопки (1 нажатие - выводится время поездки и версия программы, 2 нажатия - количество моточасов и температура процессора, долгое нажатие - переход
в меню настроек), оптимизация кода, исправлено много багов; //23.10.21
- v2.3.1 Исправление багов (не работал счётчик моточасов), добавлена функция вывода на индикатор оставшейся оперативной памяти при двойном нажатии на кнопку; //26.11.21
- v2.3.2 Исправление багов (некорректно работал счётчик моточасов и настройки из-за неправильной работы с EEPROM), добавлена функция обнуления счётчика моточасов(последний пункт меню), 
теперь все параметры в меню сохраняют значения после выключения платы, в меню настроек на TM1637 отображается "tune"; //30.11.21
- v2.3.2.1 Оптимизированы некоторые условия if, ускорен вывод температуры после включения, добавлен дефайн, при подключении которого становится возможной работа с некачественными и убитыми энкодерами (средствами библиотеки v1.12, EB_BETTER_ENC); //2.12.21
- v2.3.3 Функция изменения яркости светодиода, исправлен баг с быстрым поворотом энкодера; //6.12.21
- v2.3.4 Добавлен динамический вывод размерности температуры, режим для полушаговых энкодеров; //12.01.22
- v2.3.5 Для строк добавлен макрос F, сэкономлено 80 байт оперативки; //13.01.22
- v2.3.6 Исправление багов (неправильно работал светодиод).
Вывод строк через функцию printFromPGM (тех, которые часто повторяютя), макросы для вывода строк, сэкономлено пару байт; //16.01.22
- v2.3.7 Настройка минимального и максимального напряжения! (полезно при настройке показа предупреждений о низком или высоком напряжении,
мигании светодиода, также уровень минимального напряжения участвует в сохранении параметров в EEPROM при отключении), оптимизация записи 
и чтения EEPROM (теперь настройки сохраняются даже при отключении напряжения (из меню), тратится меньше процессорного времени, параметры меняются быстрее, 
меньше изнашивается память) //22.01.21
- v2.4.0 Добавлена поддержка активной пищалки (buzzer), добавлены директивы препроцессора ((#ifdef ... #endif) bufferBatt и RPMwarning, которые
включают код с обработкой буферного аккумулятора и предупреждения о высоких оборотах), убран серьёзный баг, который мог негативно влиять на
перезагрузку контроллера сторожевым таймером WDT, т.е. контроллер уходил в bootloop.	Это связано с тем, что контроллер автоматически ставит таймаут WDT на 16 мс и, 
если функция watchdog.enable() стоит не в начале, код до неё может выполняться дольше 16 мс (особенно со старым загрузчиком) и контроллер уходит в bootloop, 
вернее WDT перезагружает контроллер каждые 16 мс. Может случиться, что даже если сбросили таймер в начале сетапа, контроллер всё равно уходит в bootloop, 
тогда необходимо перепрошить загрузчик на optiboot или убрать его совсем. //2.02.2022 
- v2.4.1 Ускорена работа программы, количество тиков уменьшено с 51211 до 44237 (через бенчмарк AlexGyver`а). Применена библиотека GyverMAX6675, исправлен баг. //4.02.2022

![Снимок экрана (338)](https://user-images.githubusercontent.com/98914596/152585565-215a4ede-800a-409a-a3e9-cb3105b1311e.png)
![Снимок экрана (340)](https://user-images.githubusercontent.com/98914596/152585400-2c122783-a323-41d0-a48a-5dc0df8fae0f.png)

- v2.4.2 Оптимизация некоторых условий, вырезаны лишние действия, исправлены баги, функция настройки максимальной температуры цилиндров (при превышении этой температуры показывается предупреждение о перегреве цилиндров); //23.02.22 
- v2.4.3 Режим для активного/пассивного зуммера, переключается дефайном, режим теста зуммера в настройках, отлажено поведение светодиода в настройках; //5.03.22 
- v2.4.3.1 Оптимизация некоторых условий, правка комментариев; //20.04.22
- v2.4.4 Оптимизация работы с LCD1602: убраны ненужные setCursor, т.к. функция print сама переставляет курсор после выведенного слова (например можно писать
несколько параметров друг за другом), переделан вывод динамической температуры, заменены функции clear на более быстрые операции, убрано условие, при
котором значение моточасов записывалось в память каждые 10 минут, убраны лишние переменные, поправлены их типы, улучшения; //26.04.22 
- v2.4.5 Оптимизирована очистка дисплея пробелами в коде обработки указателей поворота и в коде вывода предупреждений о неисправностях на экран; //28.04.22 
- v2.5.0 Исправлен баг, из-за которого при определённых условиях в редких случаях светодиод оставался гореть (например, когда переменная z ещё соответствовала
состоянию включенного светодиода, а происходил выход из блока управления светодиодом (например температура или напряжение пришли в норму), и светодиод
оставался включенным (код выключения не выполнялся), исправлена печать символа градуса при изменении разряда температуры, 
чуть переделан вывод версии программы, другие исправления, вырезан вывод строк через функцию printFromPGM, т.к. компилятор сам оптимизирует строки, они не
дублируются в памяти, переработана структура программы для более оптимальной работы; //3.04.22
- v2.6.0 Применена библиотека GyverTimers для чёткой отработки периода теймера времени работы
(На 1 таймере может некорректно работать ШИМ на 9 и 10 пинах!), применены более лёгкие таймеры millis(), оптимизация памяти и скорости; //5.05.22 
- v2.7.0 Увеличена быстрота выполнения кода обработки указателей поворота, уменьшен вес, теперь компилитор выдаст ошибку, если одновременно
определить buzzActive и buzzPassive, предварительное объявление всех функций (быстрее компилируется), исправление ошибок, оптимизация блока
записи моточасов; //16.05.22
- v2.7.1 Переменнные, обрабатываемые в прерывании, объявлены volatile; //26.05.22
- v2.8.0 trip time заменен на более корректный elapsed time, таймаут WDT изменён с 8 сек. на 4 сек., исправлен код, небольшая правка в setup,
t1 и t2 изменены на tL и tR (левый и правый), увеличена задержка переключения CLK до 20 мкс; //23.08.22
- v2.8.1 Небольшая правка вывода ошибки #error; //31.10.22
- v2.9.0 Теперь можно определить количество цилиндров мотоцикла через define OneCylinder и TwoCylinders. Нельзя одновременно определять эти настройки, также необходимо
определить хотя бы одну из них (программа предупредит о неправильной установке определений). При одновременной установке OneCylinder и bufferBatt напряжение и
предупреждения о низком напряжении буферного аккумулятора будут находиться под температурой цилиндра.  Если в проекте не используется пьезоэлемент, можно закомментировать определения 
buzzPassive и buzzActive, и весь код, связанный с зуммером не будет скомпилирован, например, пункты Buzz Enable и Buzzer Test не будут отображаться в настройках.
В то же время нельзя одновременно определять buzzPassive и buzzActive, т.к. зуммер может иметь только один тип. Оптимизация под разные варианты сборки системы (бортового компьютера).
Правка условий вывода ошибок #error, исправления; //1.11.22
- v2.9.1 Исправления: оптимизация вывода значка градуса при изменении разрядности температуры, доработки меню настроек, переменную P сделал локальной static,
почистил структуру, применил тернарный оператор в выводе температуры, правка комментариев. //7.11.22 